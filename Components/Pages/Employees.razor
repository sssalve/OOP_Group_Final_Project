@page "/Employees"  
@using System.Globalization
@using OOP_Group_Final_Project
@using OOP_Group_Final_Project.Services
@using Blazorise
@inject NavigationManager Nav
@inject IEmployeeService EmployeeService


<div class="employee-page">
    <div class="header">
        <h3>Employee Management</h3>
    </div>

    <div class="employee-container">
        <!-- List All Employees -->
        <div class="employee-list">
            <div class="list-search">
                <input type="search"
                       placeholder="Search"
                       @bind="searchTerm"
                       @bind:event="oninput" />
            </div>

            @if (employees == null)
            {
                <p>Loading employees...</p>
            }
            else
            {
                <ul>
                    @foreach (var emp in filteredEmployees)
                    {
                        <li @onclick="() => SelectEmployee(emp)"
                            class="@(selectedEmployee?.EmployeeID == emp.EmployeeID ? "selected" : "")">
                            <div class="avatar">
                                @(string.IsNullOrEmpty(emp.FirstName) ? "?" : emp.FirstName[0])
                                @(string.IsNullOrEmpty(emp.LastName) ? "" : emp.LastName[0])
                            </div>
                            <div>
                                <div class="name">@emp.FirstName @emp.LastName</div>
                                <div class="sub">@emp.Position</div>
                            </div>
                            <span class="status-dot @(emp.DateDeparted == null ? "active" : "departed")"
                                  title="@(emp.DateDeparted == null ? "Active" : $"Departed {emp.DateDeparted:yyyy-MM-dd}")"></span>
                        </li>
                    }
                </ul>
            }

            <button class="btn btn-primary" style="width:100%; margin-top:10px" @onclick="StartAddEmployee">Add</button>
        </div>

        <!-- Display Employee Details -->
        <div class="employee-details">
            @if (!isPayTypeSelected)
            {
                <div class="form-group">
                    <h3>Employee Pay Type</h3>
                    <button class="btn btn-primary" @onclick="AddNewSalaryEmployee">
                        Salary Employee
                    </button>

                    <button class="btn btn-primary" @onclick="AddNewHourlyEmployee">
                        Hourly Employee
                    </button>
                </div>
            }

            @if (isAddingNew)
            {
                <h4>Add New Employee</h4>
                <EditForm Model="newEmployee" OnValidSubmit="SaveNewEmployee">
                    <DataAnnotationsValidator />
                    <Microsoft.AspNetCore.Components.Forms.ValidationSummary />

                    <div class="section">
                        <h4>Identity</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>First Name</label>
                                <InputText @bind-Value="newEmployee.FirstName" class="form-control" />
                            </div>
                            <div class="detail-group">
                                <label>Last Name</label>
                                <InputText @bind-Value="newEmployee.LastName" class="form-control" />
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Email</label>
                                <InputText @bind-Value="newEmployee.Email" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Role and Pay</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Position</label>
                                <InputText @bind-Value="newEmployee.Position" class="form-control" />
                            </div>
                            <div class="detail-group">
                                @if (payType == "salary")
                                {
                                    <label>Salary</label>
                                }
                                else
                                {
                                    <label>Wage</label>
                                }
                                <InputNumber TValue="decimal" @bind-Value="newEmployee.Pay" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Dates and Performance</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Hiring Date</label>
                                <DatePicker TValue="DateTime"
                                            @bind-Date="newEmployee.DateHired"
                                            AutoClose="true"
                                            Editable="false"
                                            Max="@DateTime.Today" />
                            </div>
                            <div class="detail-group">
                                <label>Departed Date (optional)</label>
                                <DatePicker TValue="DateTime?"
                                            @bind-Date="newEmployee.DateDeparted"
                                            AutoClose="true"
                                            Editable="false"
                                            Min="@(newEmployee.DateHired == default ? null : new DateTime?(newEmployee.DateHired))"
                                            Clearable="true" />
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Performance (1â€“5)</label>
                                <InputNumber TValue="int" @bind-Value="newEmployee.Performance" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelAddNew">Cancel</button>
                    </div>
                </EditForm>
            }
            else if (selectedEmployee != null)
            {
                @if (isUpdating)
                {
                    <div class="section">
                        <h4>Identity</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>First Name</label>
                                <div>
                                    Current: @selectedEmployee.FirstName
                                    <InputText @bind-Value="selectedEmployee.FirstName" class="form-control" />
                                </div>
                            </div>
                            <div class="detail-group">
                                <label>Last Name</label>
                                <div>
                                    Current: @selectedEmployee.LastName
                                    <InputText @bind-Value="selectedEmployee.LastName" class="form-control" />
                                </div>
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Email</label>
                                <div>
                                    Current: @selectedEmployee.Email
                                    <InputText @bind-Value="selectedEmployee.Email" class="form-control" />
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="section">
                        <h4>Role and Pay</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Position</label>
                                <div>
                                    Current: @selectedEmployee.Position
                                    <InputText @bind-Value="selectedEmployee.Position" class="form-control" />
                                </div>
                            </div>
                            <div class="detail-group">
                                @if (selectedEmployee.Pay > 1000)
                                {
                                    <label>Salary</label>
                                }
                                else
                                {
                                    <label>Wage</label>
                                }
                                <div>
                                    Current: @selectedEmployee.Pay.ToString("C0", CultureInfo.CurrentCulture)
                                    <InputNumber TValue="decimal" @bind-Value="selectedEmployee.Pay" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Dates and Performance</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Hiring Date</label>
                                <div>
                                    Current: @selectedEmployee.DateHired.ToString("yyyy-MM-dd")
                                    <DatePicker TValue="DateTime"
                                            @bind-Date="selectedEmployee.DateHired"
                                            AutoClose="true"
                                            Editable="false"
                                            Max="@DateTime.Today" />
                                </div>
                            </div>
                            <div class="detail-group">
                                <label>Departed Date</label>
                                <div>
                                    Current: @(selectedEmployee.DateDeparted?.ToString("yyyy-MM-dd") ?? "â€”")
                                    <DatePicker TValue="DateTime?"
                                                @bind-Date="selectedEmployee.DateDeparted"
                                                AutoClose="true"
                                                Editable="false"
                                                Min="@(selectedEmployee.DateHired == default ? null : new DateTime?(selectedEmployee.DateHired))"
                                                Clearable="true" />
                                </div>
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Performance</label>
                                <div>
                                    Current: @selectedEmployee.Performance 
                                    <InputNumber TValue="int" @bind-Value="selectedEmployee.Performance" class="form-control" />
                                </div>
                                
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="section">
                        <h4>Identity</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>First Name</label>
                                <div>@selectedEmployee.FirstName</div>
                            </div>
                            <div class="detail-group">
                                <label>Last Name</label>
                                <div>@selectedEmployee.LastName</div>
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Email</label>
                                <div>@selectedEmployee.Email</div>
                            </div>
                        </div>

                    </div>

                    <div class="section">
                        <h4>Role and Pay</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Position</label>
                                <div>@selectedEmployee.Position</div>
                            </div>
                            <div class="detail-group">
                                @if (selectedEmployee.Pay > 1000)
                                {
                                    <label>Salary</label>
                                }
                                else
                                {
                                    <label>Wage</label>
                                }
                                <div>@selectedEmployee.Pay.ToString("C0", CultureInfo.CurrentCulture)</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Dates and Performance</h4>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Hiring Date</label>
                                <div>@selectedEmployee.DateHired.ToString("yyyy-MM-dd")</div>
                            </div>
                            <div class="detail-group">
                                <label>Departed Date</label>
                                <div>@(selectedEmployee.DateDeparted?.ToString("yyyy-MM-dd") ?? "â€”")</div>
                            </div>
                            <div class="detail-group" style="grid-column:1/-1">
                                <label>Performance</label>
                                <div>@selectedEmployee.Performance</div>
                            </div>
                        </div>
                    </div>
                }


                <Modal @bind-Visible="showDeleteDialog">
                    <ModalContent>
                        <ModalHeader>
                            <ModalTitle>Confirm delete</ModalTitle>
                            <CloseButton />
                        </ModalHeader>
                        <ModalBody>
                            Are you sure you want to delete
                            <strong>@($"{selectedEmployee?.FirstName} {selectedEmployee?.LastName}")</strong>?
                            This action canâ€™t be undone.
                        </ModalBody>
                        <div class="modal-footer">
                            <button class="btn btn-edit" @onclick="CloseDeleteDialog">Cancel</button>
                            <button class="btn btn-delete" @onclick="DeleteEmployeeConfirmed">Delete</button>
                        </div>
                    </ModalContent>
                </Modal>

                <div class="action-button">
                    @if (!isUpdating)
                    {
                        <button class="btn btn-edit" @onclick="StartUpdate">Edit</button>
                        <button class="btn btn-delete" @onclick="OpenDeleteDialog">Delete</button>
                    }
                    else
                    {
                        <button class="btn btn-edit" @onclick="SaveUpdate">Save</button>
                        <button class="btn btn-delete" @onclick="CancelUpdate">Cancel</button>
                    }
                </div>
            }
            else
            {
                <p>Select an employee to view details</p>
            }
        </div>
    </div>

@if (isUpdating)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h4>Editing: @(selectedEmployee?.FirstName + " " + selectedEmployee?.LastName)</h4>
            
            <EditForm Model="newEmployee" OnValidSubmit="UpdateEmployee">
                <DataAnnotationsValidator />
                <ValidationSummary />
                
                <div class="form-group">
                    <label>First Name:</label>
                    <InputText @bind-Value="newEmployee.FirstName" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Last Name:</label>
                    <InputText @bind-Value="newEmployee.LastName" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Position:</label>
                    <InputText @bind-Value="newEmployee.Position" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Salary:</label>
                    <InputNumber @bind-Value="newEmployee.Salary" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <InputText @bind-Value="newEmployee.Email" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Performance (1â€“5):</label>
                    <InputNumber @bind-Value="newEmployee.Performance" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Hiring date:</label>
                    <InputDate @bind-Value="newEmployee.DateHired" class="form-control" />
                </div>
                @if (newEmployee.DateDeparted.HasValue)
                {
                    <div class="form-group">
                        <label>Departure date:</label>
                        <InputDate @bind-Value="newEmployee.DateDeparted" class="form-control" />
                    </div>
                }
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="CancelUpdate">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </EditForm>
        </div>
    </div>
}

</div>

@code {
    private List<Employee> employees;
    private Employee selectedEmployee = null;
    private bool isAddingNew = false;
    private Employee newEmployee;
    private bool isUpdating = false;
    private bool isPayTypeSelected = true;
    private string payType = "salary";
    Salaried salaryEmployee = new Salaried();
    FullTime fullTimeEmployee = new FullTime();

    private string searchTerm = string.Empty; //added search bar
    private IEnumerable<Employee> filteredEmployees =>
        string.IsNullOrWhiteSpace(searchTerm) || employees is null
            ? employees ?? Enumerable.Empty<Employee>()
            : employees.Where(e =>
                $"{e.FirstName} {e.LastName} {e.Email} {e.Position}"
                .Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        employees = await EmployeeService.GetAllEmployeesAsync();
    }

    private void GoHome()
    {
        Nav.NavigateTo("/", forceLoad: false, replace: true);
    }

    private void SelectEmployee(Employee employee)
    {
        selectedEmployee = employee;
        isAddingNew = false;
        isUpdating = false;
        isPayTypeSelected = true;
    }

    private void StartAddEmployee()
    {
        isAddingNew = false;
        selectedEmployee = null;
        isUpdating = false;
        isPayTypeSelected = false;
    }

    private void AddNewSalaryEmployee()
    {
        newEmployee = new Salaried();
        isAddingNew = true;
        selectedEmployee = null;
        isUpdating = false;
        isPayTypeSelected = true;
        payType = "salary";
    }

    private void AddNewHourlyEmployee()
    {
        newEmployee = new FullTime();
        isAddingNew = true;
        selectedEmployee = null;
        isUpdating = false;
        isPayTypeSelected = true;
        payType = "hourly";
    }

    private async Task SaveNewEmployee()
    {
        await EmployeeService.AddEmployeeAsync(newEmployee);
        employees = await EmployeeService.GetAllEmployeesAsync();
        isAddingNew = false;
    }

    private void CancelAddNew()
    {
        isAddingNew = false;
    }

    private void StartUpdate()
    {
        isUpdating = true;
        if (selectedEmployee.Pay > 1000)
        {

            Salaried salaryEmployee = new Salaried()
            {
                EmployeeID = selectedEmployee.EmployeeID,
                FirstName = selectedEmployee.FirstName,
                LastName = selectedEmployee.LastName,
                Position = selectedEmployee.Position,
                Pay = selectedEmployee.Pay,
                Salary = selectedEmployee.Pay,
                Email = selectedEmployee.Email,
                DateHired = selectedEmployee.DateHired,
                DateDeparted = selectedEmployee.DateDeparted

            };
            selectedEmployee = salaryEmployee;
        }
        else
        {
            FullTime fullTimeEmployee = new FullTime()
            {
                EmployeeID = selectedEmployee.EmployeeID,
                FirstName = selectedEmployee.FirstName,
                LastName = selectedEmployee.LastName,
                Position = selectedEmployee.Position,
                Pay = selectedEmployee.Pay,
                Wage = selectedEmployee.Pay,
                Email = selectedEmployee.Email,
                DateHired = selectedEmployee.DateHired,
                DateDeparted = selectedEmployee.DateDeparted

            };
            selectedEmployee = fullTimeEmployee;
        }
    }

    private async void SaveUpdate()
    {
        isUpdating = false;
        await EmployeeService.UpdateEmployeeAsync(selectedEmployee);
    }

    private void CancelUpdate()
    {
        isUpdating = false;
    }

    private async Task UpdateEmployee()
    {
        await EmployeeService.UpdateEmployeeAsync(newEmployee);
        employees = await EmployeeService.GetAllEmployeesAsync();
        
        // update the selected employee with new data
        selectedEmployee = employees.FirstOrDefault(e => e.EmployeeID == newEmployee.EmployeeID);
        
        isUpdating = false;
        StateHasChanged();
    }

    private void CancelUpdate()
    {
        isUpdating = false;
    }

    private async Task DeleteEmployee()
    {
        if (selectedEmployee != null)
        {
            await EmployeeService.DeleteEmployeeAsync(selectedEmployee.EmployeeID);
            employees = await EmployeeService.GetAllEmployeesAsync();
            selectedEmployee = null;
        }
    }

    private bool showDeleteDialog;

    private void OpenDeleteDialog()
    {
        if (selectedEmployee is null) return;
        showDeleteDialog = true;
    }
    private void CloseDeleteDialog() => showDeleteDialog = false;

    private async Task DeleteEmployeeConfirmed()
    {
        if (selectedEmployee is null) return;
        await EmployeeService.DeleteEmployeeAsync(selectedEmployee.EmployeeID);
        employees = await EmployeeService.GetAllEmployeesAsync();
        selectedEmployee = null;
        showDeleteDialog = false;
    }

}